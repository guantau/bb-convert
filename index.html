<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Currency converter for Byteball</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<meta name="format-detection" content="telephone=no" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha256-Md8eaeo67OiouuXAi8t/Xpd8t2+IaJezATVTWbZqSOw=" crossorigin="anonymous" />
	<style>
	body {
		display: table;
		position: absolute;
		height: 100%;
		width: 100%;
	}

	.jumbotron {
		display: table-cell !important;
		vertical-align: middle;
	}
	.sticky-footer {
		position: absolute;
		left: 0;
		bottom: 0;
		width: 100%;
		padding: 10px;
	}
	</style>
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-15428727-5', 'auto');
	ga('send', 'pageview');
	</script>
</head>
<body>
	<div class="jumbotron d-flex align-items-center">
		<div class="container-fluid text-center">
			<div class="row">
				<div class="input-group input-group-md mb-3 col-lg-2">
					<input class="form-control" type="number" id="amount_to_send" min="0" placeholder="Amount to send" />
					<div class="input-group-append">
						<label class="input-group-text" id="amount_to_send_label" for="amount_to_send">?</label>
					</div>
				</div>
				<div class="input-group input-group-md mb-3 col-lg-3">
					<div class="input-group-prepend">
						<label class="input-group-text" for="currency_rate" title="close and re-open tab to refresh rates">Currency</label>
					</div>
					<select class="form-control" id="currency_rate" title="close and re-open tab to refresh rates"><option value="0" rel="">-- choose currency --</option></select>
				</div>
				<div class="input-group input-group-md mb-3 col-lg-4">
					<input class="form-control" type="text" id="bb_address" placeholder="Byteball address" />
					<div class="input-group-append">
						<label class="input-group-text" for="bb_address">Address</label>
					</div>
				</div>
				<div class="input-group input-group-md mb-3 col-lg-3">
					<a class="btn btn-primary col-lg-12" role="button" id="send-button" href="https://byteball.org/#download">send with Byteball wallet</a>
				</div>
			</div>
			<div class="row">
				<div class="col-12" id="conversion"></div>
			</div>
		</div>
	</div>
	<div class="sticky-footer text-center"><a id="donate" href="https://github.com/tarmo888/bb-convert">donate $5 to author of this tool</a></div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="launch_uri/launch_uri.js?v2"></script>
	<script type="text/javascript">
	$(document).ready(function() {
		// updates URL fragment and re-calculates Byte amounts
		$('#amount_to_send, #currency_rate, #bb_address').on('change', function(e) {
			updateUrlFragment();
			updateAmount();
		});
		// regular send button
		$('#send-button').on('click', function(e) {
			e.preventDefault();
			updateUrlFragment();
			var launch_uri = false;
			if (launch_uri = updateAmount()) {
				launchUri(launch_uri, function () {
					if (typeof ga === 'function') {
						ga('send', 'event', 'send-button', 'success', $('#currency_rate option:selected').attr('rel'));
					}
				}, function () {
					alert('Unable to launch Byteball wallet.\nClick OK to redirect to download page.');
					window.location = $(e.target).attr('href');
					if (typeof ga === 'function') {
						ga('send', 'event', 'send-button', 'fail', $('#currency_rate option:selected').attr('rel'));
					}
				}, function () {
					if (typeof ga === 'function') {
						ga('send', 'event', 'send-button', 'unknown', $('#currency_rate option:selected').attr('rel'));
					}
				});
			}
			else {
				if (typeof ga === 'function') {
					ga('send', 'event', 'send-button', 'fill-fields');
				}
				alert('Please fill all fields!');
			}
		});
		// donate button with pre-filled inputs
		$('#donate').on('click', function(e) {
			e.preventDefault();
			$('#amount_to_send').val(5);
			$("#currency_rate option").removeAttr("selected");
			$("#currency_rate option[rel='USD']").attr("selected", "selected");
			$('#bb_address').val('NTYO4ZKPRBPXW6WY2QUMJBPNDLOGX5OJ');
			updateUrlFragment();
			var launch_uri = false;
			if (launch_uri = updateAmount()) {
				launchUri(launch_uri, function () {
					if (typeof ga === 'function') {
						ga('send', 'event', 'donate-button', 'success', $('#currency_rate option:selected').attr('rel'));
					}
				}, function () {
					alert('Unable to launch Byteball wallet.\n\nThis tool was made by tarmo888');
					if (typeof ga === 'function') {
						ga('send', 'event', 'donate-button', 'fail', $('#currency_rate option:selected').attr('rel'));
					}
				}, function () {
					if (typeof ga === 'function') {
						ga('send', 'event', 'donate-button', 'unknown', $('#currency_rate option:selected').attr('rel'));
					}
				});
			}
			else {
				if (typeof ga === 'function') {
					ga('send', 'event', 'donate-button', 'fill-fields');
				}
				alert('USD currency not loaded!');
			}
		});
		// all cryptocompare base currencies
		var url = 'https://min-api.cryptocompare.com/data/price?fsym=GBYTE&tsyms=USD,EUR,GBP,BTC,ETH,GOLD,AUD,BRL,CAD,CHF,CNY,HKD,HUF,INR,JPY,KRW,MXN,NZD,PHP,PLN,RON,RUB,SGD,VEF';
		var cache_key = utf8_to_b64(url);
		var settings = {'selected_currency': ''};
		if (typeof window.localStorage !== 'undefined') {
			// saves selected currency in local storage for longer
			settings = JSON.parse(localStorage.getItem(cache_key)) || settings;
			$('#currency_rate').on('change', function(e) {
				settings.selected_currency = $('#currency_rate option:selected').attr('rel');
				localStorage.setItem(cache_key, JSON.stringify(settings));
			});
		}
		if (typeof window.sessionStorage !== 'undefined') {
			// keeps cached in session storage for reloading the page, clears cache on closing the tab
			var cached_rates = JSON.parse(sessionStorage.getItem(cache_key));
			if (cached_rates) {
				rates = cached_rates;
				drawRates(rates);
				if (typeof ga === 'function') {
					ga('send', 'event', 'CryptoCompare', 'cached-rates');
				}
			}
			else {
				$.get(url, function(response) {
					rates = response;
					drawRates(rates);
					sessionStorage.setItem(cache_key, JSON.stringify(response));
					if (typeof ga === 'function') {
						ga('send', 'event', 'CryptoCompare', 'new-rates');
					}
				});
			}
		}
		// calculates Byte amounts and returns launch URI
		function updateAmount() {
			var amount_to_send = parseFloat($('#amount_to_send').val());
			var currency_rate = parseFloat($('#currency_rate').val());
			var bb_address = $('#bb_address').val();
			if (currency_rate) {
				$('#amount_to_send_label').html($('#currency_rate option:selected').attr('rel'));
				if (amount_to_send) {
					$('#conversion').html('');
					$('#conversion').append('<div>'+ (amount_to_send/currency_rate).toFixed(9) +' GBYTE</div>');
					$('#conversion').append('<div>'+ (amount_to_send/currency_rate*1e3).toFixed(6) +' MBYTE</div>');
					$('#conversion').append('<div>'+ (amount_to_send/currency_rate*1e6).toFixed(3) +' KBYTE</div>');
					$('#conversion').append('<div>'+ (amount_to_send/currency_rate*1e9).toFixed(0) +' BYTE</div>');
				}
			}
			else {
				$('#amount_to_send_label').html('?');
			}
			if (!amount_to_send || !currency_rate || !bb_address) {
				return false;
			}
			var bb_amount = (amount_to_send/currency_rate*1e9).toFixed(0);
			var params = parseParams(window.location.hash);
			if (params.testnet) {
				return 'byteball-tn:'+ bb_address +'?amount='+ bb_amount;
			}
			else {
				return 'byteball:'+ bb_address +'?amount='+ bb_amount;
			}
		}
		// updates URL fragment based on input values
		function updateUrlFragment() {
			if (typeof history.replaceState !== 'undefined') {
				if ( parseFloat($('#amount_to_send').val()) || $('#currency_rate option:selected').attr('rel') || $('#bb_address').val() ) {
					var params = parseParams(window.location.hash);
					var fragment = '#amount='+ ($('#amount_to_send').val() ? parseFloat($('#amount_to_send').val()) : '') +'&currency='+ $('#currency_rate option:selected').attr('rel') + '&address='+ $('#bb_address').val() + (params.testnet ? '&testnet=1' : '');
					history.replaceState(null, null, fragment);
				}
				else {
					history.replaceState(null, null, '#');
				}
			}
		}
		// fills currency dropdown and pre-fills inputs
		function drawRates(rates) {
			// currency rates loop
			for (i in rates) {
				$('#currency_rate').append('<option value="'+ rates[i] +'" rel="'+ i +'">'+ i +' ('+ rates[i] +' = GBYTE)</option>');
			}
			var params = parseParams(window.location.hash);
			// pre-fill amount from URL fragment
			if (params.amount) {
				$('#amount_to_send').val(parseInt(params.amount));
				$("#amount_to_send").trigger("change");
			}
			if (params.currency) {
				settings.selected_currency = params.currency;
			}
			// pre-select currency from dropdown (either from last use or from URL fragment)
			if (settings.selected_currency && $("#currency_rate option[rel='"+ settings.selected_currency +"']").length) {
				$("#currency_rate option").removeAttr("selected");
				$("#currency_rate option[rel='"+ settings.selected_currency +"']").attr("selected", "selected");
				$("#currency_rate").trigger("change");
			}
			// pre-fill address from URL fragment
			if (params.address) {
				$('#bb_address').val(params.address);
				$("#bb_address").trigger("change");
			}
		}
		// for parsing windows.location.search or windows.location.hash
		function parseParams(params) {
			var hash = params.substring(1);
			var param_list = {}
			$.each(hash.split('&') , function( key, value ) {
				var temp = value.split('=');
				param_list[temp[0]] = temp[1];
			});
			return param_list;
		}
		// for making unique cache key
		function utf8_to_b64( str ) {
			return window.btoa(encodeURIComponent(escape( str )));
		}
		function b64_to_utf8( str ) {
			return unescape(decodeURIComponent(window.atob( str )));
		}
	});
	</script>
</body>
</html>
